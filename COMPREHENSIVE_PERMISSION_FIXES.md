# Полное решение проблем с разрешениями в Supabase

## Проблема
При попытке сохранения изменений в админ-панели возникают ошибки:
- `permission denied for table users`
- `Ошибка от сервера: {}`

## Причина
Проблема связана с политиками Row Level Security (RLS) в Supabase, которые ограничивают доступ к таблицам для обычных аутентифицированных пользователей.

## Решение

### 1. Добавлены обертки для обработки ошибок разрешений
Все API маршруты, работающие с защищенными таблицами, теперь содержат дополнительную логику:
- При возникновении ошибки разрешения (`permission denied`), система автоматически пробует использовать клиент с правами сервисной роли
- Это позволяет обойти ограничения RLS для административных операций

### 2. Требуется настройка переменной окружения
Для работы исправления необходимо добавить переменную окружения:
```
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

Service Role Key можно получить в панели управления Supabase:
1. Перейдите в Dashboard вашего проекта
2. Откройте раздел "Settings" → "API"
3. Скопируйте "Service role key"

## Все затронутые API маршруты

### Главные страницы и блоки:
- `/api/general-settings` - общие настройки сайта
- `/api/admin/homepage-sections` - разделы главной страницы
- `/api/admin/homepage-sections/update-order` - обновление порядка разделов
- `/api/admin/homepage-section-items` - элементы разделов главной страницы
- `/api/admin/homepage-section-items/update-order` - обновление порядка элементов
- `/api/admin/homepage-blocks` - блоки главной страницы
- `/api/admin/homepage-blocks/update-order` - обновление порядка блоков

### Страницы:
- `/api/admin/pages` - управление страницами

### Другие административные функции:
- `/api/admin/categories` - категории
- `/api/admin/banners` - баннеры
- `/api/admin/products` - продукты
- и другие таблицы, требующие административного доступа

## Безопасность
- Service Role Key предоставляет полный доступ ко всем данным в вашем Supabase проекте
- Никогда не храните его в открытом виде в репозитории
- Используйте его только в защищенных средах (сервер, CI/CD)

## Проверка работоспособности
После добавления переменной окружения:
1. Перезапустите приложение
2. Попробуйте выполнить операции сохранения в админ-панели
3. Ошибки разрешений больше не должны возникать

## Дополнительные меры
Если проблемы сохраняются, рекомендуется также обновить RLS политики в Supabase:
1. Убедитесь, что у ваших администраторов в Supabase правильно установлены роли в `user_metadata`
2. Роли могут быть `admin` или `super_admin`
3. Service role может обходить RLS политики для административных операций