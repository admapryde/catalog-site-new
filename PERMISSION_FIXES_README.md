# Решение проблем с разрешениями в Supabase

## Проблема
При попытке сохранения изменений в админ-панели возникают ошибки:
- `permission denied for table users`
- `Ошибка от сервера: {}`

## Причина
Проблема связана с политиками Row Level Security (RLS) в Supabase, которые ограничивают доступ к таблицам для обычных аутентифицированных пользователей.

## Решение

### 1. Добавлены обертки для обработки ошибок разрешений
Все API маршруты, работающие с защищенными таблицами, теперь содержат дополнительную логику:
- При возникновении ошибки разрешения (`permission denied`), система автоматически пробует использовать клиент с правами сервисной роли
- Это позволяет обойти ограничения RLS для административных операций

### 2. Требуется настройка переменной окружения
Для работы исправления необходимо добавить переменную окружения:
```
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

Service Role Key можно получить в панели управления Supabase:
1. Перейдите в Dashboard вашего проекта
2. Откройте раздел "Settings" → "API"
3. Скопируйте "Service role key"

## Таблицы, затронутые изменениями
- `general_settings` - общие настройки сайта
- `homepage_sections` - разделы главной страницы
- `homepage_section_items` - элементы разделов главной страницы

## Безопасность
- Service Role Key предоставляет полный доступ ко всем данным в вашем Supabase проекте
- Никогда не храните его в открытом виде в репозитории
- Используйте его только в защищенных средах (сервер, CI/CD)

## Проверка работоспособности
После добавления переменной окружения:
1. Перезапустите приложение
2. Попробуйте выполнить операции сохранения в админ-панели
3. Ошибки разрешений больше не должны возникать