# Руководство по новой архитектуре главной страницы

## Обзор

Новая архитектура главной страницы позволяет гибко управлять структурой и содержимым главной страницы через админ-панель. Она основана на концепции динамических блоков, которые могут быть настраиваемыми и переставляемыми.

## Структура данных

### Таблицы в базе данных

#### homepage_blocks
Хранит информацию о блоках главной страницы:
- `id` - UUID, первичный ключ
- `type` - тип блока (categories_grid, banner_slider, homepage_sections и т.д.)
- `position` - позиция блока на странице
- `settings` - JSONB объект с настройками блока
- `visible` - видимость блока
- `enabled` - включен ли блок
- `created_at`, `updated_at` - временные метки


## Типы блоков

### Существующие типы:
- `categories_grid` - сетка категорий
- `banner_slider` - слайдер баннеров
- `homepage_sections` - разделы с товарами
- `custom_content` - пользовательский контент с заголовком, текстом и изображением

### Возможные будущие типы:
- `video_block` - видео-блок
- `testimonial_block` - отзывы
- `call_to_action_block` - призыв к действию

## Настройки блоков

Каждый блок может иметь собственные настройки, хранящиеся в поле `settings` (JSONB):

### Пример настроек для разных типов:

#### categories_grid:
Настройки для этого типа блока можно задать через интерфейс редактора:
- Название: влияет на заголовок, который отображается над сеткой категорий
- Максимальное количество категорий: по умолчанию 16, можно увеличивать или уменьшать

При сохранении формируется JSON:
```json
{
  "title": "Название для сетки категорий",
  "max_display_count": 16
}
```

#### banner_slider:
Настройки для этого типа блока можно задать через интерфейс редактора:
- Выбор групп баннеров: позволяет выбрать, какие группы баннеров будут отображаться в этом блоке
- Автоматическая прокрутка: включает/выключает автоматическую смену баннеров
- Время прокрутки: интервал времени между сменой баннеров (в миллисекундах)
- Показывать индикаторы: отображение точек-переключателей между баннерами
- Показывать навигацию: отображение стрелок "вперед/назад" для переключения баннеров

При сохранении формируется JSON:
```json
{
  "selected_group_ids": ["group-id-1", "group-id-2"],
  "auto_rotate": true,
  "rotation_interval": 5000,
  "show_indicators": true,
  "show_navigation": true
}
```

#### homepage_sections:
Настройки для этого типа блока можно задать через интерфейс редактора:
- Выбор разделов главной страницы: позволяет выбрать, какие разделы будут отображаться в этом блоке
- Стиль отображения: сетка, список или карусель
- Количество колонок: количество колонок для отображения товаров
- Показывать цены: включает/выключает отображение цен товаров
- Показывать описания: включает/выключает отображение описаний товаров

При сохранении формируется JSON:
```json
{
  "selected_section_ids": ["section-id-1", "section-id-2"],
  "display_style": "grid",
  "columns": 4,
  "show_prices": true,
  "show_descriptions": false
}
```

#### custom_content:
Настройки для этого типа блока можно задать через интерфейс редактора:
- Название: заголовок для блока пользовательского контента
- Текст: основной текстовый контент блока
- Изображение: форма для загрузки изображения через компонент FileUpload, который загружает изображение на Cloudinary и сохраняет URL в базе данных

При сохранении формируется JSON:
```json
{
  "title": "Заголовок пользовательского контента",
  "text": "Текстовое содержимое",
  "image_url": "https://res.cloudinary.com/..."
}
```

## API маршруты

### Административные маршруты:
- `GET /api/admin/homepage-blocks` - получить все блоки
- `POST /api/admin/homepage-blocks` - создать блок
- `PUT /api/admin/homepage-blocks` - обновить блок
- `DELETE /api/admin/homepage-blocks?id=...` - удалить блок


### Публичные маршруты:
- `GET /api/homepage-structure` - получить структуру главной страницы

## Сервисы

### homepage-structure-service.ts

Основной сервис для работы с новой архитектурой:

```typescript
import { getHomepageStructure } from '@/services/homepage-structure-service';

// Получение структуры главной страницы
const homepageStructure = await getHomepageStructure();
```

Другие доступные функции:
- `getAllHomepageBlocks()` - получить все блоки
- `createHomepageBlock()` - создать блок
- `updateHomepageBlock()` - обновить блок
- `deleteHomepageBlock()` - удалить блок
- `invalidateHomepageStructureCache()` - инвалидировать кэш

## Компоненты

### DynamicHomepage.tsx
Универсальный компонент для отображения главной страницы на основе новой архитектуры:

```tsx
import DynamicHomepage from '@/components/DynamicHomepage';

export default function HomePage() {
  return (
    <DynamicHomepage />
  );
}
```

### Модернизированные компоненты

#### CategoriesGrid.tsx
Теперь принимает дополнительные параметры:
- `maxDisplayCount` - максимальное количество отображаемых категорий
- `showImages` - показывать ли изображения
- `columns` - количество колонок в сетке

#### BannerSlider.tsx
Теперь принимает дополнительные параметры:
- `autoRotate` - автопрокрутка
- `rotationInterval` - интервал автопрокрутки
- `showIndicators` - показывать ли индикаторы
- `showNavigation` - показывать ли навигационные кнопки

#### HomepageSections.tsx
Теперь принимает дополнительные параметры:
- `displayStyle` - стиль отображения (grid, list, carousel)
- `columns` - количество колонок
- `showPrices` - показывать ли цены
- `showDescriptions` - показывать ли описания

## Админ-панель

### Редактор главной страницы
Доступен по адресу `/admin/homepage-editor`, позволяет:
- Управлять макетами главной страницы
- Управлять блоками главной страницы
- Настраивать параметры каждого блока
- Включать/выключать блоки
- Управлять видимостью блоков

## Примеры использования

### Пример настройки макета
```json
{
  "name": "Мобильный макет",
  "is_default": false,
  "settings": {
    "optimized_for": "mobile",
    "priority": "fast_loading"
  }
}
```

### Пример настройки блока сетки категорий
```json
{
  "type": "categories_grid",
  "position": 1,
  "settings": {
    "title": "Популярные категории",
    "max_display_count": 8,
    "show_images": true,
    "columns": 4
  },
  "visible": true,
  "enabled": true
}
```

### Пример настройки блока слайдера баннеров
```json
{
  "type": "banner_slider",
  "position": 2,
  "settings": {
    "auto_rotate": true,
    "rotation_interval": 7000,
    "show_indicators": true,
    "show_navigation": false,
    "animation_type": "fade"
  },
  "visible": true,
  "enabled": true
}
```

## Обратная совместимость

Главная страница (app/page.tsx) поддерживает обратную совместимость:
- Если новая структура недоступна, используется старая реализация
- Все существующие функции продолжают работать
- Постепенный переход к новой архитектуре

## Безопасность

- Политики RLS обеспечивают безопасный доступ к данным
- Только администраторы могут изменять структуру и настройки
- Публичные данные (структура главной страницы) доступны для чтения всем пользователям

## Кэширование

- Структура главной страницы кэшируется на сервере
- При изменении блоков или макетов кэш инвалидируется
- Используется многоуровневое кэширование для оптимизации производительности